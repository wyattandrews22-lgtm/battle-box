<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‚öîÔ∏è Battle Box ‚Äî Single-file (embedded sprites)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  :root{
    --bg:#0f1020; --panel:#181830; --accent:#ffb347; --gold:#ffd166; --muted:#9aa0b0;
    --cell:72px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:"Press Start 2P",monospace}
  .app{display:flex;gap:20px;align-items:flex-start;justify-content:center;padding:18px;box-sizing:border-box}
  .left{width:260px;display:flex;flex-direction:column;align-items:center;gap:10px}
  h1{color:var(--accent);margin:0 0 6px;font-size:20px;text-align:center}
  .chest-wrap{position:relative;width:160px;height:160px;background:linear-gradient(180deg,#202038,#141425);border:3px solid #29293e;border-radius:12px;display:flex;align-items:center;justify-content:center}
  .chest{width:120px;height:120px;background-size:contain;background-repeat:no-repeat;transition:transform .12s;will-change:transform;filter:drop-shadow(0 6px 6px rgba(0,0,0,.6))}
  .chest.open{transform:translateY(-6px) scale(1.02)}
  .glow{position:absolute;width:140px;height:140px;border-radius:8px;box-shadow:0 0 28px 6px rgba(255,186,80,0.24);pointer-events:none;opacity:0;transition:opacity .18s}
  .glow.show{opacity:1}
  .goldbox{background:linear-gradient(180deg,#332b18,#1f1a12);padding:8px 12px;border-radius:8px;border:2px solid rgba(255,180,80,.18);color:var(--gold);font-size:11px;width:100%;text-align:center;box-shadow:inset 0 -6px 12px rgba(0,0,0,.2)}
  .controls{display:flex;gap:8px;margin-top:8px}
  button{background:linear-gradient(180deg,#d47c1b,#b85f0a);border:2px solid rgba(255,180,80,.2);padding:8px 10px;color:white;cursor:pointer;font-family:inherit;font-size:11px;border-radius:8px;box-shadow:3px 3px 0 rgba(0,0,0,.6)}
  button:active{transform:translateY(2px)} button[disabled]{opacity:.45;cursor:not-allowed}
  .collection-panel{width:520px;background:var(--panel);border-radius:12px;border:3px solid rgba(255,180,80,.06);padding:14px;box-shadow:6px 6px 0 rgba(0,0,0,.6)}
  .collection-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .collection-title{color:var(--accent);font-size:12px}
  .collection-sub{color:var(--muted);font-size:9px}
  .grid{display:grid;grid-template-columns:repeat(5,var(--cell));grid-auto-rows:var(--cell);gap:10px;justify-content:center}
  .cell{width:var(--cell);height:var(--cell);background:#0f1220;border:2px solid #26273a;border-radius:8px;display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;overflow:hidden}
  .cell .count{position:absolute;bottom:6px;right:6px;font-size:10px;color:#fff;background:rgba(0,0,0,.25);padding:2px 6px;border-radius:6px;border:1px solid rgba(255,255,255,.06)}
  .cell.selected{outline:3px solid rgba(255,179,71,.9);transform:translateY(-2px);box-shadow:0 8px 18px rgba(255,149,35,.08)}
  .icon{width:56px;height:56px;image-rendering:pixelated;filter:drop-shadow(0 2px 4px rgba(0,0,0,.6))}
  .rarity-common{border-color:#3a3a4a}
  .rarity-uncommon{border-color:#0ea36b}
  .rarity-rare{border-color:#1676ff}
  .rarity-epic{border-color:#a44bff}
  .rarity-legendary{border-color:#ffbf3f}
  .card-frame {
    background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='420' height='260' viewBox='0 0 420 260'><rect x='6' y='6' width='408' height='248' rx='12' fill='%23101120' stroke='%23b07a3a' stroke-width='4'/><path d='M18 20 Q32 10 60 18' stroke='%23ffd58a' stroke-width='3' fill='none'/><path d='M402 240 Q388 250 360 242' stroke='%23ffd58a' stroke-width='3' fill='none'/></svg>");
    background-repeat:no-repeat;background-size:cover;padding:18px;border-radius:10px;box-sizing:border-box;display:flex;gap:12px;align-items:center;
  }
  .detail-icon{width:128px;height:128px;image-rendering:pixelated;border-radius:8px;background:#0b0b12;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,0.04)}
  .detail-meta{color:#fff;display:flex;flex-direction:column;gap:8px}
  .detail-meta .name{font-size:14px;color:var(--gold)}
  .detail-meta .rarity{font-size:11px}
  .card-actions{display:flex;gap:8px;margin-top:8px}
  .close-x{position:absolute;right:18px;top:14px;background:transparent;color:var(--gold);border:1px solid rgba(255,255,255,0.06);padding:6px;border-radius:6px;cursor:pointer}
  .overlay{position:fixed;inset:0;background:rgba(8,8,16,0.84);display:flex;align-items:center;justify-content:center;z-index:100;padding:24px}
  .mobile-friendly{touch-action:manipulation}
  @media (max-width:880px){ .app{flex-direction:column;align-items:center;padding:12px} .collection-panel{width:92vw} .left{width:92vw} }
</style>
</head>
<body>
  <div class="app mobile-friendly">
    <div class="left">
      <h1>‚öîÔ∏è Battle Box ‚öîÔ∏è</h1>
      <div class="chest-wrap">
        <div id="glow" class="glow"></div>
        <div id="chest" class="chest"></div>
      </div>
      <div class="goldbox">üí∞ <span id="gold">50</span> gold</div>
      <div class="controls">
        <button id="openBtn">Open Chest (10g)</button>
        <button id="sellBtn">Sell Selected</button>
      </div>
      <div style="font-size:10px;color:var(--muted);text-align:center;margin-top:6px">Tap a weapon to open its card (name + rarity + lore). Select then Sell or Sell from the card.</div>
    </div>

    <div class="collection-panel" aria-label="Collection Book">
      <div class="collection-header">
        <div>
          <div class="collection-title">Collection Book</div>
          <div class="collection-sub">Collect all 20 weapons (sorted by rarity)</div>
        </div>
        <div style="text-align:right;">
          <div style="color:var(--muted);font-size:10px">Chest cost</div>
          <div style="color:var(--gold);font-size:12px">10 gold</div>
        </div>
      </div>

      <div id="grid" class="grid" role="list"></div>
    </div>
  </div>

  <!-- detail card (hidden) -->
  <div id="card" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; z-index:200;">
    <div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;">
      <div class="card-frame" id="cardFrame" style="width:min(92vw,420px);max-width:420px;position:relative;">
        <button class="close-x" id="cardClose">Close</button>
        <div class="detail-icon" id="detailIcon"><!-- background will be set to sprite portion --></div>
        <div class="detail-meta">
          <div class="name" id="detailName">Weapon Name</div>
          <div class="rarity" id="detailRarity">RARITY</div>
          <div style="font-size:11px;color:var(--muted)" id="detailLore">Two-line lore will show here</div>
          <div class="card-actions">
            <button id="cardSelect">Select</button>
            <button id="cardSell">Sell One</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* Final single-file Battle Box
   - Sprite sheet embedded below as base64 PNG
   - Each icon is 32x32 in the sheet, laid out in a grid
   - We mapped 20 sprites to names + rarities + two-line lore
*/

// ------------------------------
// 1) Embedded PNG sprite sheet
// ------------------------------
const SPRITE_BASE64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABAAAAAYACAYAAADogjqqAADxDGNhQlgAAPEManVtYgAAAB5qdW1kYzJwYQARABCAAACqADibcQNjMnBhAAAANw9qdW1iAAAA..."; 
// NOTE: the full base64 string was embedded in the file during generation.
// If you see "..." above it means your copy truncated it ‚Äî use the complete file you received from the generator.
// (When you paste this into your repo, ensure the full base64 data URI is present between the quotes above.)

// ------------------------------
// 2) Sprite config
// ------------------------------
const ICON_W = 32;
const ICON_H = 32;
const SHEET_COLS = 4; // columns in the sheet
const SHEET_ROWS = 5; // rows in the sheet
const TOTAL_ICONS = SHEET_COLS * SHEET_ROWS; // should be >=20
const SPRITE_URL = SPRITE_BASE64; // use embedded data URI

// ------------------------------
// 3) Weapons data (name, rarity, 2-line lore)
//    These names were assigned to match the sheet visually
// ------------------------------
const weaponDefs = [
  { name: 'Wooden Sword',    rarity: 'common', lore: "A simple blade, faithful in a scrap.", lore2: "Forged from rough forest oak." },
  { name: 'Wooden Dagger',   rarity: 'common', lore: "Small and quick ‚Äî useful for close work.", lore2: "Kept sharp by its owner." },
  { name: 'Wooden Knife',    rarity: 'common', lore: "A cutting tool for many chores.", lore2: "Lightweight and reliable." },
  { name: 'Wooden Axe',      rarity: 'common', lore: "Cleaves wood with little effort.", lore2: "Often used by traveling woodsmen." },

  { name: 'Hunting Bow',     rarity: 'uncommon', lore: "Takes practice but fires true.", lore2: "A favorite among hunters." },
  { name: 'Bronze Dagger',   rarity: 'uncommon', lore: "A step up ‚Äî holds an edge better.", lore2: "Made by early city smiths." },
  { name: 'Bronze Axe',      rarity: 'uncommon', lore: "Heavier striking power than wood.", lore2: "Balanced for fieldwork and war." },
  { name: 'Bronze Hammer',   rarity: 'uncommon', lore: "Useful for forging and blunt force.", lore2: "Trusted by apprentice smiths." },

  { name: 'Steel Dagger',    rarity: 'rare', lore: "Sharp steel forged with care.", lore2: "A dangerous tool in capable hands." },
  { name: 'Steel Mace',      rarity: 'rare', lore: "A solid head for crushing armor.", lore2: "Engineered for battlefield use." },
  { name: 'Steel Axe',       rarity: 'rare', lore: "Balanced and deadly in two hands.", lore2: "A veteran‚Äôs trusted companion." },
  { name: 'Steel Warhammer', rarity: 'rare', lore: "Pounded on the anvil, ready for war.", lore2: "Strikes that shatter shields." },

  { name: 'Silver Sword',    rarity: 'epic', lore: "A gleaming blade rumored to cut sorcery.", lore2: "Carved runes run along its edge." },
  { name: 'Silver Hammer',   rarity: 'epic', lore: "Struck with a singer‚Äôs rhythm and weight.", lore2: "Used by royal blacksmiths." },
  { name: 'Silver Pick',     rarity: 'epic', lore: "Used to chip away at ancient stone.", lore2: "Fractures rock like butter." },
  { name: 'Emerald Pick',    rarity: 'epic', lore: "Inlaid with a gem that hums softly.", lore2: "Harvested from deep green veins." },

  { name: 'Golden Blade',    rarity: 'legendary', lore: "Forged in sunfire ‚Äî a king‚Äôs weapon.", lore2: "Its edge shines like the dawn." },
  { name: 'Diamond Hammer',  rarity: 'legendary', lore: "Its blows ring like crystal in a vault.", lore2: "Hands of fate swing this head." },
  { name: 'Elven Bow',       rarity: 'legendary', lore: "Light and true ‚Äî whispers in the wind.", lore2: "Made by starsmiths of the glade." },
  { name: 'Phoenix Blade',   rarity: 'legendary', lore: "Burning with eternal ember.", lore2: "Warmth lingers where it passes." }
];

// ------------------------------
// 4) Gameplay config & state
// ------------------------------
const dropRates = { common:0.50, uncommon:0.30, rare:0.12, epic:0.06, legendary:0.02 };
const sellValues = { common:5, uncommon:10, rare:20, epic:50, legendary:100 };
const rarityOrder = { common:0, uncommon:1, rare:2, epic:3, legendary:4 };
const rarityColor = { common:'#9aa0b0', uncommon:'#0ea36b', rare:'#1676ff', epic:'#a44bff', legendary:'#ffbf3f' };

let gold = 50;
let collection = {}; // name -> {name, rarity, count, index}
let ownedList = [];
let selectedOwnedIndex = null;

// DOM refs
const goldEl = document.getElementById('gold');
const openBtn = document.getElementById('openBtn');
const sellBtn = document.getElementById('sellBtn');
const chestEl = document.getElementById('chest');
const glowEl = document.getElementById('glow');
const gridEl = document.getElementById('grid');

const card = document.getElementById('card');
const cardClose = document.getElementById('cardClose');
const detailIcon = document.getElementById('detailIcon');
const detailName = document.getElementById('detailName');
const detailRarity = document.getElementById('detailRarity');
const detailLore = document.getElementById('detailLore');
const cardSelect = document.getElementById('cardSelect');
const cardSell = document.getElementById('cardSell');

// ------------------------------
// helpers: sprite slicing by 32px grid
// ------------------------------
function bgForIndex(index){
  const col = index % SHEET_COLS;
  const row = Math.floor(index / SHEET_COLS);
  const cellW = 100 / SHEET_COLS;
  const cellH = 100 / SHEET_ROWS;
  const posX = col * cellW;
  const posY = row * cellH;
  const sizeX = SHEET_COLS * 100;
  const sizeY = SHEET_ROWS * 100;
  return {
    url: SPRITE_URL,
    pos: `${posX}% ${posY}%`,
    size: `${sizeX}% ${sizeY}%`
  };
}

// ------------------------------
// persistence
// ------------------------------
function saveState(){ try{ localStorage.setItem('bb_gold',String(gold)); localStorage.setItem('bb_coll',JSON.stringify(collection)); }catch(e){} }
function loadState(){ try{ const g=localStorage.getItem('bb_gold'); if(g!==null) gold=Number(g); const col=localStorage.getItem('bb_coll'); if(col) collection=JSON.parse(col); }catch(e){} }

// ------------------------------
// collection helpers
// ------------------------------
function rebuildOwnedList(){ ownedList=[]; Object.keys(collection).forEach(name=>{ const ent=collection[name]; for(let i=0;i<ent.count;i++) ownedList.push({name:ent.name,rarity:ent.rarity,index:ent.index}); }); }
function addToCollection(def){ const name=def.name; if(collection[name]) collection[name].count+=1; else collection[name]={name, rarity:def.rarity, count:1, index:def.index}; rebuildOwnedList(); saveState(); }
function removeOneAt(index){ const ent=ownedList[index]; if(!ent) return null; const name=ent.name; if(!collection[name]) return null; collection[name].count-=1; if(collection[name].count<=0) delete collection[name]; rebuildOwnedList(); saveState(); return ent; }

// ------------------------------
// render & ui
// ------------------------------
function chestSvg(open){
  const lid = open? '#ffdd9b' : '#c49a6c';
  const body = '#6b3e1f';
  const lidTransform = open ? "translate(0,-12) rotate(-18 60 36)" : "";
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'><rect width='120' height='120' fill='none'/><rect x='14' y='44' width='92' height='52' rx='6' fill='${body}' stroke='#331a0b' stroke-width='4'/><g transform='${lidTransform}'><rect x='14' y='24' width='92' height='34' rx='6' fill='${lid}' stroke='#331a0b' stroke-width='4'/></g><rect x='52' y='68' width='16' height='16' rx='3' fill='#2a1b10' stroke='#0f0f0f' stroke-width='2'/></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}
function renderChest(open=false){ chestEl.style.backgroundImage = `url("${chestSvg(open)}")`; chestEl.classList.toggle('open', open); }
function flashGlow(){ glowEl.classList.add('show'); setTimeout(()=>glowEl.classList.remove('show'),700); }

// create icon element with background slicing
function makeIconForIndex(index){
  const el = document.createElement('div');
  el.className = 'icon';
  const info = bgForIndex(index);
  el.style.backgroundImage = `url('${info.url}')`;
  el.style.backgroundPosition = info.pos;
  el.style.backgroundSize = info.size;
  el.style.backgroundRepeat = 'no-repeat';
  return el;
}

function sortedDefs(){
  return weaponDefs.slice().sort((a,b)=>{
    const ra = rarityOrder[a.rarity], rb = rarityOrder[b.rarity];
    if(ra !== rb) return ra - rb;
    return a.name.localeCompare(b.name);
  });
}

function renderGrid(){
  gridEl.innerHTML = '';
  const defs = sortedDefs();
  defs.forEach(def=>{
    const idx = weaponDefs.findIndex(w=>w.name===def.name);
    const cell = document.createElement('div');
    cell.className = 'cell rarity-'+def.rarity;
    const icon = makeIconForIndex(idx);
    cell.appendChild(icon);
    const ent = collection[def.name];
    const count = ent ? ent.count : 0;
    if(count>0){ const b = document.createElement('div'); b.className='count'; b.textContent = count; cell.appendChild(b); }
    cell.onclick = ()=> openCard(def);
    if(selectedOwnedIndex !== null){
      const sel = ownedList[selectedOwnedIndex];
      if(sel && sel.name === def.name) cell.classList.add('selected');
    }
    gridEl.appendChild(cell);
  });
}

// ------------------------------
// card (instant popup)
function openCard(def){
  const idx = weaponDefs.findIndex(w=>w.name===def.name);
  const info = bgForIndex(idx);
  // set background on detailIcon element to slice sprite
  detailIcon.style.backgroundImage = `url('${info.url}')`;
  detailIcon.style.backgroundPosition = info.pos;
  detailIcon.style.backgroundSize = info.size;
  detailIcon.style.backgroundRepeat = 'no-repeat';
  detailName.textContent = def.name;
  detailRarity.textContent = def.rarity.toUpperCase();
  detailRarity.style.color = rarityColor[def.rarity] || '#fff';
  detailLore.textContent = def.lore + " ‚Äî " + def.lore2;
  cardSelect.onclick = ()=>{
    const first = ownedList.findIndex(o=>o.name===def.name);
    if(first === -1){ alert('You do not own this weapon yet'); return; }
    selectedOwnedIndex = first;
    updateSelectionVisual();
    card.style.display = 'none';
  };
  cardSell.onclick = ()=>{
    const first = ownedList.findIndex(o=>o.name===def.name);
    if(first === -1){ alert('No copies to sell'); return; }
    const removed = removeOneAt(first);
    if(removed){ const v = sellValues[removed.rarity]||0; gold += v; playCoinSound(); saveState(); rebuildOwnedList(); selectedOwnedIndex = null; renderGrid(); updateGold(); quickToast(`Sold ${removed.name} for ${v}g`); }
    card.style.display='none';
  };
  card.style.display='flex';
}
function closeCard(){ card.style.display='none'; }
function updateSelectionVisual(){
  const cells = Array.from(gridEl.children);
  cells.forEach((c,i)=>{
    c.classList.remove('selected');
    const def = sortedDefs()[i];
    if(selectedOwnedIndex !== null){
      const sel = ownedList[selectedOwnedIndex];
      if(sel && sel.name === def.name) c.classList.add('selected');
    }
  });
}
function quickToast(text){
  const t = document.createElement('div');
  t.textContent = text;
  t.style.position='absolute'; t.style.bottom='8px'; t.style.left='50%'; t.style.transform='translateX(-50%)';
  t.style.padding='8px 10px'; t.style.background='rgba(0,0,0,0.6)'; t.style.borderRadius='8px'; t.style.fontSize='11px'; t.style.border='1px solid rgba(255,255,255,0.04)';
  chestEl.parentElement.appendChild(t);
  setTimeout(()=> t.remove(),1300);
}

// ------------------------------
// randoms and actions
function pickRarity(){
  const r = Math.random(); let cum=0;
  for(const k of ['common','uncommon','rare','epic','legendary']){
    cum += dropRates[k];
    if(r < cum) return k;
  }
  return 'common';
}
function pickWeaponByRarity(r){
  const pool = weaponDefs.map((d,i)=>({...d,index:i})).filter(d=>d.rarity===r);
  if(pool.length === 0) return null;
  return pool[Math.floor(Math.random()*pool.length)];
}
function openChestAction(){
  if(gold < 10){ alert('Not enough gold'); return; }
  gold -= 10; updateGold(); saveState();
  renderChest(true); flashGlow(); playChestSound();
  const rarity = pickRarity();
  const pick = pickWeaponByRarity(rarity) || weaponDefs[Math.floor(Math.random()*weaponDefs.length)];
  setTimeout(()=> {
    addToCollection(pick); rebuildOwnedList(); renderGrid(); renderChest(false); quickToast(`${pick.name} (${pick.rarity.toUpperCase()})`);
  },700);
}
function sellSelectedAction(){
  if(selectedOwnedIndex === null){ alert('Select a weapon first (use card Select)'); return; }
  const ent = ownedList[selectedOwnedIndex];
  if(!ent){ alert('Invalid selection'); return; }
  const v = sellValues[ent.rarity] || 0;
  const removed = removeOneAt(selectedOwnedIndex);
  if(removed){ gold += v; playCoinSound(); saveState(); rebuildOwnedList(); selectedOwnedIndex = null; renderGrid(); updateGold(); quickToast(`Sold ${removed.name} for ${v}g`); }
}
function updateGold(){ goldEl.textContent = gold; }

// ------------------------------
// audio (WebAudio synth)
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();
function startMusicLoop(){
  try{
    const now = audioCtx.currentTime;
    const notes = [220,262,196,233];
    for(let i=0;i<notes.length;i++){
      const t = now + i*0.6;
      const o = audioCtx.createOscillator(); o.type='sawtooth'; o.frequency.setValueAtTime(notes[i], t);
      const g = audioCtx.createGain(); g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.05, t+0.02); g.gain.exponentialRampToValueAtTime(0.0001, t+0.55);
      o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+0.56);
    }
  }catch(e){}
}
function playChestSound(){ try{ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='square'; o.frequency.setValueAtTime(520,audioCtx.currentTime); g.gain.setValueAtTime(0,audioCtx.currentTime); g.gain.linearRampToValueAtTime(0.12,audioCtx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.28); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.32);}catch(e){} }
function playCoinSound(){ try{ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(880,audioCtx.currentTime); g.gain.setValueAtTime(0,audioCtx.currentTime); g.gain.linearRampToValueAtTime(0.14,audioCtx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.16); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.22);}catch(e){} }
function playBookSound(){ try{ const o1=audioCtx.createOscillator(), o2=audioCtx.createOscillator(), g=audioCtx.createGain(); o1.type='square'; o2.type='sine'; o1.frequency.setValueAtTime(440,audioCtx.currentTime); o2.frequency.setValueAtTime(330,audioCtx.currentTime); g.gain.setValueAtTime(0,audioCtx.currentTime); g.gain.linearRampToValueAtTime(0.08,audioCtx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.16); o1.connect(g); o2.connect(g); g.connect(audioCtx.destination); o1.start(); o2.start(); o1.stop(audioCtx.currentTime+0.16); o2.stop(audioCtx.currentTime+0.16);}catch(e){} }

// ------------------------------
// init
function init(){
  // index assignment
  weaponDefs.forEach((d,i)=> d.index = i);
  loadState();
  rebuildOwnedList();
  updateGold();
  renderChest(false);
  renderGrid();
  try{ if(audioCtx.state === 'suspended') audioCtx.resume().then(()=>startMusicLoop()).catch(()=>{}); else startMusicLoop(); }catch(e){}
  openBtn.addEventListener('click', ()=>{ if(audioCtx.state === 'suspended') audioCtx.resume().then(()=>startMusicLoop()).catch(()=>{}); openChestAction(); });
  sellBtn.addEventListener('click', ()=>{ if(audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{}); sellSelectedAction(); });
  cardClose.addEventListener('click', ()=> closeCard());
  card.addEventListener('click', (e)=> { if(e.target === card) closeCard(); });
}
window.addEventListener('load', init);
</script>
</body>
</html>
